<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Postgresql for analytics, Brief overview</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css"
          integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <meta name="google-site-verification" content="nKBS68MBglsXyUBNGGsQ7oQZU53wrBmnye0L6Fu4jBU"/>
    <script src="https://browser.sentry-cdn.com/4.6.5/bundle.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">Sentry.init({dsn: 'https://802d42edef034b74860743196de2cac2@sentry.io/1423759'});</script>
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
</head>
<body>
<div class="article-header">
    <div class="py-5 text-center">
        <h1>Postgresql for analytics</h1>
        <h3>brief overview</h3>
    </div>
    <hr/>
</div>
<div class="container">
    <p>In this article we will discover main analytics features of postgresql. If you are familiar with
    classic sql, you can find some postgres specific features witch will boost your analytic experience. </p>
    <b>Topics</b>
    <ul>
        <li>
            <a href="#with">WITH expression</a>
        </li>
        <li>
            <a href="#filtering">Filtering</a>
        </li>
        <li>
            <a href="#">Joining</a>
        </li>
        <li>
            <a href="#">Grouping</a>
        </li>
        <li>
            <a href="#">Window function</a>
        </li>
        <li>
            <a href="#">JSON</a>
        </li>
        <li>
            <a href="#">Performance issues</a>
        </li>
        <li>
            <a href="#">Views</a>
        </li>
        <li>
            <a href="#">ROW_NUMBER(), RANK(),  DENSE_RANK() </a>
        </li>
        <li>
            <a href="#">FIRST_VALUE / LAST_VALUE</a>
        </li>
        <li>
            <a href="#">LAG / LEAD</a>
        </li>
        <li>
            <a href="#">GROUPING</a>
        </li>
        <li>
            <a href="#">ROLLUP</a>
        </li>
        <li>
            <a href="#">Cube</a>
        </li>
    </ul>
</div>
<hr/>
<div class="container">
    <h3>Dataset</h3>
    <p><b>Schema</b>:<br/><img src="data/db-schema.png" alt="" class="img-fluid" /></p>
    <p><b>City table:</b><br/><img src="data/db-table-city.png" alt="" class="img-fluid" /></p>
    <p><b>Country table:</b><br/><img src="data/db-table-country.png" alt="" class="img-fluid" /></p>
    <p><b>Countrylanguage table:</b><br/><img src="data/db-table-countrylanguage.png" alt="" class="img-fluid" /></p>

    <p>[<a href="data/db-world.zip">db-world.zip</a>]</p>
</div>
<hr/>
<div class="container">
    <h3>
        <a href="#" name="with">#</a> CTE (Common table expression)
    </h3>
    <p>CTE (with expression) allow you to write your queries in chain style rather that classic sql statements where your write "deep queries".
    Step by step you can extend your query using previous results. Lets look in example above:</p>
    <pre><code class="sql">SELECT countrycode, langcount
FROM (
         SELECT countrycode, COUNT(*) as langcount
         FROM countrylanguage
         GROUP BY countrycode
     ) country_lang_count
WHERE langcount > 1
ORDER BY langcount DESC;</code></pre>
    <pre><code class="sql">WITH country_lang_count AS (SELECT countrycode, COUNT(*) as langcount
                            FROM countrylanguage
                            GROUP BY countrycode)
SELECT countrycode, langcount
FROM country_lang_count
WHERE langcount > 1
ORDER BY langcount DESC;</code></pre>
    <p>As you can see CTE simplify understanding of your queries. But real power of WITH expression is RECURSIVE ability.
    Lets implement query that evaluate sum of first N numbers (sum[1..N]) with <code>RECURSIVE WITH</code>:</p>
    <pre><code class="sql">WITH RECURSIVE t(n) AS (
    VALUES (1)
    UNION ALL
    SELECT n + 1
    FROM t
    WHERE n < 100
)
SELECT SUM(n)
FROM t;</code></pre>
    <p>You can find details in <a href="https://www.postgresql.org/docs/12/queries-with.html">documentation</a>.</p>
</div>
<div class="container">
    <h3>
        <a href="#" name="filtering">#</a> Filtering
    </h3>
    <p>If we want to filter data in sql query than we typically user <code>WHERE</code> statement with combination of
        conditions like query above, but postgres allows to use <code>filter</code> inside select for <code>groupby</code>.
    </p>
    <pre><code class="sql">SELECT countrycode,
       avg(population) FILTER ( WHERE population > 10000 ) AS avg_population
FROM city
GROUP BY countrycode;</code></pre>
    <pre><code class="sql">SELECT countrycode,
       avg(population) AS avg_population
FROM (
         SELECT countrycode, population
         FROM city
         WHERE population > 10000
     ) city_population
GROUP BY countrycode;</code></pre>
    <p>Note that in first query results can contains <code>null</code> in case when countrycode has no cities with
        <code>population > 10000</code>.</p>
</div>
<hr/>
<!-- https://www.postgresqltutorial.com/ -->

<div class="container">
    <div class="row">
        <div class="col-2"><img class="d-block mx-auto mb-4 rounded"
                                src="https://avatars1.githubusercontent.com/u/669347?s=100" alt=""
                                width="100"
                                height="100"></div>
        <div class="col-8">
            <p>Author <a href="https://mrkandreev.name/">@mrkandreev</a></p>
            <p>Machine Learning Engineer</p>
        </div>
    </div>
</div>
<script>hljs.initHighlightingOnLoad();</script>
<!-- Yandex.Metrika counter -->
<script type="text/javascript"> (function (d, w, c) {
    (w[c] = w[c] || []).push(function () {
        try {
            w.yaCounter41245659 = new Ya.Metrika2({
                id: 41245659,
                clickmap: true,
                trackLinks: true,
                accurateTrackBounce: true,
                webvisor: true,
                trackHash: true
            });
        } catch (e) {
        }
    });
    var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () {
        n.parentNode.insertBefore(s, n);
    };
    s.type = "text/javascript";
    s.async = true;
    s.src = "https://mc.yandex.ru/metrika/tag.js";
    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else {
        f();
    }
})(document, window, "yandex_metrika_callbacks2"); </script>
<noscript>
    <div><img src="https://mc.yandex.ru/watch/41245659" style="position:absolute; left:-9999px;" alt=""/></div>
</noscript> <!-- /Yandex.Metrika counter -->
</body>
</html>
